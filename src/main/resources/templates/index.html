<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>GraphQL Demo - Quản lý Sản phẩm</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        /* Tùy chỉnh thêm cho nội dung chính để không bị dính sát lề */
        .main-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .product-item {
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>

    <div th:replace="fragments :: header"></div>

    <div class="container">
        <div class="main-content">

            <div class="mb-5">
                <h3 class="text-primary mb-3"> Thêm sản phẩm mới</h3>
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="newTitle" class="form-control"
                            placeholder="Tên sản phẩm (VD: iPhone 15)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="newPrice" class="form-control" placeholder="Giá (VD: 1500)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="newCatId" class="form-control" placeholder="ID Danh mục (VD: 1)">
                    </div>
                    <div class="col-md-12">
                        <input type="text" id="newDesc" class="form-control" placeholder="Mô tả chi tiết sản phẩm">
                    </div>
                    <div class="col-md-2">
                        <button id="btnAdd" class="btn btn-success w-100">Lưu sản phẩm</button>
                    </div>
                </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-dark m-0">Danh sách sản phẩm</h3>
                <button id="btnLoad" class="btn btn-primary btn-sm"> Tải dữ liệu</button>
            </div>

            <div id="container" class="list-group list-group-flush">
                <p class="text-muted fst-italic">Đang chờ tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <div th:replace="fragments :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {

            // Load danh sách
            $("#btnLoad").click(function () {
                const query = `
                    query {
                        getAllProductsSorted {
                            id, title, price, descr
                            category { name }
                        }
                    }
                `;
                $.ajax({
                    url: "/graphql", type: "POST", contentType: "application/json",
                    data: JSON.stringify({ query: query }),
                    success: function (response) {
                        const products = response.data.getAllProductsSorted;
                        let html = "";
                        if (!products || products.length === 0) {
                            html = "<div class='alert alert-warning'>Chưa có sản phẩm nào.</div>";
                        } else {
                            products.forEach(p => {
                                const catName = p.category ? p.category.name : "Chưa phân loại";
                                html += `
                                    <div class="product-item">
                                        <div>
                                            <h5 class="mb-1 text-primary">${p.title} <small class="text-muted">#${p.id}</small></h5>
                                            <p class="mb-1">Giá: <strong>${p.price}</strong> | DM: <span class="badge bg-secondary">${catName}</span></p>
                                            <small class="text-muted">${p.descr || ''}</small>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${p.id})">Xóa</button>
                                    </div>
                                `;
                            });
                        }
                        $("#container").html(html);
                    }
                });
            });

            // Thêm mới
            $("#btnAdd").click(function () {
                const title = $("#newTitle").val();
                const price = parseFloat($("#newPrice").val());
                const catId = $("#newCatId").val();
                const descr = $("#newDesc").val() || "";

                if (!title || !price || !catId) { alert("Thiếu thông tin!"); return; }

                const mutation = `
                    mutation {
                        createProduct(input: {
                            title: "${title}", price: ${price}, categoryId: "${catId}",
                            descr: "${descr}", quantity: 10, userid: 1
                        }) { id }
                    }
                `;

                $.ajax({
                    url: "/graphql", type: "POST", contentType: "application/json",
                    data: JSON.stringify({ query: mutation }),
                    success: function (res) {
                        if (res.errors) alert("Lỗi: " + res.errors[0].message);
                        else {
                            alert("Thêm thành công!");
                            $("#newTitle").val(""); $("#newPrice").val(""); $("#newDesc").val("");
                            $("#btnLoad").click();
                        }
                    }
                });
            });

            $("#btnLoad").click();
        });

        function deleteProduct(id) {
            if (!confirm("Xóa sản phẩm " + id + "?")) return;
            const mutation = `mutation { deleteProduct(id: ${id}) }`;
            $.ajax({
                url: "/graphql", type: "POST", contentType: "application/json",
                data: JSON.stringify({ query: mutation }),
                success: function (res) {
                    if (res.data.deleteProduct) { alert("Đã xóa!"); $("#btnLoad").click(); }
                    else alert("Lỗi khi xóa!");
                }
            });
        }
    </script>
</body>

</html>